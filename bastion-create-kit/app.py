from flask import Flask, render_template, request, flash, redirect, url_for
import subprocess as sp
import os, time

app = Flask(__name__)
# flash ë©”ì‹œì§€ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ê¸° ìœ„í•œ ì‹œí¬ë¦¿ í‚¤
app.config['SECRET_KEY'] = 'a-very-secret-key-that-should-be-changed'

# Kickstart í…œí”Œë¦¿
KS_TEMPLATE = """
# Kickstart file for RHEL 9.6 Bastion VM - Generated by WebUI
lang ko_KR.UTF-8
keyboard --xlayouts='kr'
timezone Asia/Seoul --utc
rootpw --plaintext ##ROOT_PASSWORD##


# BaseOSì™€ AppStream ë¦¬í¬ì§€í† ë¦¬ë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì§€ì •
url --url="http://##HTTP_SERVER_IP##:8080/rhel9.6/BaseOS"
repo --name="AppStream" --baseurl="http://##HTTP_SERVER_IP##:8080/rhel9.6/AppStream"
network --bootproto=static --device=enp1s0 --ip=192.168.122.100 --netmask=255.255.255.0 --gateway=192.168.122.1 --nameserver=8.8.8.8,8.8.4.4 --hostname=##HOSTNAME## --activate

# --- í•µì‹¬ íŒŒí‹°ì…˜ ì„¤ì • (ìˆ˜ë™ ë°©ì‹) ---
# 1. ë””ìŠ¤í¬ì˜ ëª¨ë“  íŒŒí‹°ì…˜ì„ ê¹¨ë—í•˜ê²Œ ì§€ì›ë‹ˆë‹¤.
clearpart --all --initlabel
# 2. ë¶€íŒ…ì— í•„ìš”í•œ /boot íŒŒí‹°ì…˜ì„ 1GBë¡œ ìƒì„±í•©ë‹ˆë‹¤.
part /boot --fstype="xfs" --size=1024
# 3. ë‚˜ë¨¸ì§€ ëª¨ë“  ê³µê°„ì„ ì°¨ì§€í•˜ëŠ” LVM ë¬¼ë¦¬ ë³¼ë¥¨ì„ ìƒì„±í•©ë‹ˆë‹¤.
#    --size=1 --grow ì˜µì…˜ì´ ë‚¨ì€ ê³µê°„ ì „ì²´ë¥¼ ì‚¬ìš©í•˜ë¼ëŠ” ì˜ë¯¸ì…ë‹ˆë‹¤.
part pv.01 --size=1 --grow
# 4. 'rootvg' ë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ë³¼ë¥¨ ê·¸ë£¹ì„ ìƒì„±í•©ë‹ˆë‹¤.
volgroup rootvg pv.01
# 5. swap ê³µê°„ì„ 4GBë¡œ ìƒì„±í•©ë‹ˆë‹¤. (í•„ìš”ì— ë”°ë¼ í¬ê¸° ì¡°ì ˆ)
logvol swap --vgname=rootvg --name=lv_swap --size=4096
# 6. ë‚¨ì€ ëª¨ë“  ê³µê°„ì„ ë£¨íŠ¸(/) íŒŒí‹°ì…˜ìœ¼ë¡œ í• ë‹¹í•©ë‹ˆë‹¤.
#    --size=1 --grow ì˜µì…˜ì„ ì‚¬ìš©í•´ ë‚¨ì€ ê³µê°„ ì „ì²´ë¥¼ í• ë‹¹í•©ë‹ˆë‹¤.
logvol / --vgname=rootvg --name=lv_root --fstype="xfs" --size=1 --grow


# --- í•µì‹¬ íŒŒí‹°ì…˜ ì„¤ì • ---
# 1. ë””ìŠ¤í¬ì˜ ëª¨ë“  íŒŒí‹°ì…˜ì„ ê¹¨ë—í•˜ê²Œ ì§€ì›ë‹ˆë‹¤.
#clearpart --all --initlabel

# 2. ìë™ìœ¼ë¡œ íŒŒí‹°ì…˜ì„ ì„¤ì •í•©ë‹ˆë‹¤.
#Â  Â  - /boot íŒŒí‹°ì…˜ê³¼ swap íŒŒí‹°ì…˜ì€ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤.
#Â  Â  - --nohome ì˜µì…˜ìœ¼ë¡œ /home íŒŒí‹°ì…˜ì„ ë§Œë“¤ì§€ ì•Šê³ ,
#Â  Â  Â  ë‚¨ì€ ëª¨ë“  ê³µê°„ì„ ë£¨íŠ¸(/) íŒŒí‹°ì…˜ì— í• ë‹¹í•©ë‹ˆë‹¤.
#autopart --nohome




services --enabled="chronyd,httpd,named"
firewall --enabled --service=ssh,http,https
bootloader --location=mbr --boot-drive=vda
graphical

%packages
@^graphical-server-environment
haproxy
bind
bind-utils
chrony
httpd
httpd-tools
python3
python3-pip
ansible-core
nmstate
wget
podman
skopeo
jq
tar
gcc
python3-devel
rsync
policycoreutils-python-utils
%end


%post --log=/root/ks-post.log
pip3 install Flask Flask-WTF


# Add user with specified password
useradd user
echo 'user:Redhat123!@#' | chpasswd




%end

reboot

"""

@app.route('/', methods=['GET', 'POST'])
def index():
    if request.method == 'POST':
        action = request.form.get('action')
        try:
            if action == 'generate_kickstart':
                ks_content = KS_TEMPLATE.replace("##ROOT_PASSWORD##", request.form.get('root_password')) \
                                        .replace("##HTTP_SERVER_IP##", request.form.get('http_server_ip')) \
                                        .replace("##HOSTNAME##", request.form.get('hostname')) 

                ks_path = "/var/www/html/kickstart/ks.cfg"
                with open(ks_path, "w") as f:
                    f.write(ks_content)
                
                #sp.run(['sudo', 'restorecon', '-v', ks_path], check=True)
                flash(f"âœ… Kickstart íŒŒì¼ì´ {ks_path} ì— ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.", 'success')

            elif action == 'download_iso':
                # ì‚¬ìš©ìê°€ ì…ë ¥í•œ URLì„ ê°€ì ¸ì˜µë‹ˆë‹¤
                iso_url = request.form.get('iso_url_from_user')
                if not iso_url or not iso_url.startswith('http'):
                    flash("âŒ ì˜¤ë¥˜: ìœ íš¨í•œ ë‹¤ìš´ë¡œë“œ URLì„ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.", 'danger')
                    return redirect(url_for('index'))

                # ë‹¤ìš´ë¡œë“œë  íŒŒì¼ ì´ë¦„ ì§€ì • (URLì´ ë³µì¡í•˜ë¯€ë¡œ ê³ ì •ëœ ì´ë¦„ ì‚¬ìš©)
                iso_filename = "rhel-9.6-x86_64-dvd.iso"
                download_path = f"/tmp/{iso_filename}"
                mount_path = "/var/www/html/rhel9.6"

                flash(f"ISO ë‹¤ìš´ë¡œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤... (ëŒ€ìƒ: {mount_path})", 'info')
               
                # wgetê³¼ mount ì‹¤í–‰
                sp.run(['sudo', 'wget', '-O', download_path, iso_url], check=True)
                sp.run(['sudo', 'mount', '-o', 'loop', download_path, mount_path], check=True)
                
                flash(f"âœ… ISO ì´ë¯¸ì§€ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œí•˜ê³  {mount_path} ì— ë§ˆìš´íŠ¸í–ˆìŠµë‹ˆë‹¤.", 'success')

                # [ìˆ˜ì •] ë§ˆìš´íŠ¸ëœ ë””ë ‰í„°ë¦¬ì— ì˜¬ë°”ë¥¸ SELinux ì»¨í…ìŠ¤íŠ¸ë¥¼ ì¬ê·€ì ìœ¼ë¡œ ì ìš©
                #sp.run(['sudo', 'restorecon', '-Rv', mount_path], check=True)

                flash(f"âœ… ISO ì´ë¯¸ì§€ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë§ˆìš´íŠ¸í–ˆìŠµë‹ˆë‹¤ ({mount_path}).", 'success')



            elif action == 'create_vm':
                http_server_ip = request.form.get('http_server_ip')
                # vCPUs, RAM, Disk Size ê°’ ì½ì–´ì˜¤ê¸°
                vm_name = request.form.get('vm_name')
                vcpus = request.form.get('vm_vcpus', '8')
                ram_gb = int(request.form.get('vm_ram', '16'))
                disk_size = request.form.get('disk_size', '500')

                # RAMì„ GBì—ì„œ MBë¡œ ë³€í™˜
                ram_mb = ram_gb * 1024
                
                location_url = f"http://{http_server_ip}:8080/rhel9.6/"
                ks_location = f"http://{http_server_ip}:8080/kickstart/ks.cfg"

                disk_dir = "/KVM_data/vm"
                os.makedirs(disk_dir, exist_ok=True)
                disk_path = f"{disk_dir}/{vm_name}.qcow2"
                if os.path.exists(disk_path):
                    flash(f"âŒ ë””ìŠ¤í¬ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤: {disk_path}", 'danger')
                    return redirect(url_for('index'))

                # virt-install ëª…ë ¹ì–´ì— ë™ì  ê°’ ì ìš©
                virt_install_cmd = [
                    'sudo', 'virt-install',
                    '--name', vm_name,
                    '--ram', str(ram_mb),
                    '--vcpus', vcpus,
                    '--disk', f'path={disk_path},size={disk_size},format=qcow2,bus=virtio',
                    '--network', 'bridge=virbr0',
                    '--graphics', 'vnc,listen=0.0.0.0',
                    '--location', location_url,
                    f'--extra-args=inst.ks={ks_location}',
                    '--noautoconsole'
                ]






                result = sp.run(virt_install_cmd, stdout=sp.PIPE, stderr=sp.PIPE, text=True, check=True)
                flash("ğŸš€ VM ìƒì„± ëª…ë ¹ì„ ì‹¤í–‰í–ˆìŠµë‹ˆë‹¤. `virt-manager` ë˜ëŠ” `virsh list`ë¡œ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.", 'success')

        except sp.CalledProcessError as e:
            err = e.stderr if e.stderr else str(e)
            flash(f"âŒ ëª…ë ¹ì–´ ì‹¤í–‰ ì˜¤ë¥˜: {e.stderr}", 'danger')
        except TypeError as e:
            try:
                result = sp.run(virt_install_cmd, stdout=sp.PIPE, stderr=sp.PIPE, universal_newlines=True, check=True)
                flash("ğŸš€ VM ìƒì„± ëª…ë ¹ì„ ì‹¤í–‰í–ˆìŠµë‹ˆë‹¤. `virt-manager` ë˜ëŠ” `virsh list`ë¡œ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.", 'success')
            except sp.CalledProcessError as ee:
                err = ee.stderr if ee.stderr else str(ee)
                flash(f"âŒ ëª…ë ¹ì–´ ì‹¤í–‰ ì˜¤ë¥˜: {err}", 'danger')
        except Exception as e:
            flash(f"âŒ ì¼ë°˜ ì˜¤ë¥˜ ë°œìƒ: {e}", 'danger')

        return redirect(url_for('index'))

    return render_template('index.html')

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5011, debug=True)
